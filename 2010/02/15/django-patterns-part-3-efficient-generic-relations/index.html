<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>Django patterns part 3: efficient generic relations</title>
        <link rel="stylesheet" href="../../../../theme/css/main.css" />

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../../../../">rosemanblog </a></h1>
                <nav><ul>
                    <li class="active"><a href="../../../../category/technical.html">Technical</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="../../../../2010/02/15/django-patterns-part-3-efficient-generic-relations/" rel="bookmark"
           title="Permalink to Django patterns part 3: efficient generic relations">Django patterns part 3: efficient generic relations</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2010-02-15T15:04:55">
                Mon 15 February 2010
        </abbr>

        <address class="vcard author">
                By <a class="url fn" href="../../../../author/daniel-roseman.html">Daniel Roseman</a>
        </address>
<p>In <a href="../../../../category/technical.html">Technical</a>. </p>
<p>tags: <a href="../../../../tag/django.html">django</a><a href="../../../../tag/patterns.html">patterns</a><a href="../../../../tag/generic-relation.html">generic-relation</a><a href="../../../../tag/query-efficiency.html">query-efficiency</a></p>
</footer><!-- /.post-info -->      <p>I've previously talked about how to make <a href="/2010/01/11/django-patterns-part-2-efficient-reverse-lookups/">reverse lookups more efficient</a> using a simple dictionary trick. Today I want to write about how this can be extended to generic relations.</p>
<p>At its heart, a generic relationship is defined by two elements: a foreign key to the ContentType table, to determine the type of the related object, and an ID field, to identify the specific object to link to. Django uses these two elements to provide a <code>content_object</code> pseudo-field which, to the user, works similarly to a real ForeignKey field. And, again just like a ForeignKey, Django can helpfully provide a reverse relationship from the linked model back to the generic one, although you do need to explicitly define this using generic.GenericRelation to make Django aware of it.</p>
<p>As usual, though, the real inefficiency arises when you are accessing reverse relationships for a whole lot of items - say, each item in a QuerySet. As with reverse foreign keys, Django will attempt to resolve this relationship individually for each item, resulting in a whole lot of queries. The solution is a little different, though, to take into account the added complexity of generic relations.</p>
<p>Assuming the list of items is all of one type, the first step is to get the content type ID for this model. From that, we can get the object IDs, and then do the query in one go. From there, we can use the dictionary trick described last time to associate each item with its particular related items. In this example, we have an Asset model that is the generic model, holding assets for other models such as Article and Gallery.</p>
<div class="highlight"><pre><span class="n">articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="n">article_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">article</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">article</span> <span class="k">for</span> <span class="n">article</span> <span class="ow">in</span> <span class="n">articles</span><span class="p">])</span>

<span class="n">article_ct</span> <span class="o">=</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_for_model</span><span class="p">(</span><span class="n">Article</span><span class="p">)</span>
<span class="n">assets</span> <span class="o">=</span> <span class="n">Asset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">content_type</span><span class="o">=</span><span class="n">article_type</span><span class="p">,</span> 
                <span class="n">object_id__in</span><span class="o">=</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">all_articles</span><span class="p">]</span>
              <span class="p">)</span>
<span class="n">asset_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">asset</span> <span class="ow">in</span> <span class="n">assets</span><span class="p">:</span>
    <span class="n">asset_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">asset</span><span class="o">.</span><span class="n">object_id</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">asset</span><span class="p">)</span>
<span class="k">for</span> <span class="nb">id</span><span class="p">,</span> <span class="n">related_items</span> <span class="ow">in</span> <span class="n">asset_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">article_dict</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span><span class="o">.</span><span class="n">_assets</span> <span class="o">=</span> <span class="n">related_items</span>
</pre></div>


<p>This is good as far as it goes, but what about when we have a heterogeneous list of items? That, after all, is the point of generic relations. So what if our starting point is a collection of both Galleries and Articles, and we still want to get all the related Assets in one go? As it turns out, the solution is not massively different: we just need to change the way we key the items in the intermediate dictionary, to record the content type as well as the object ID.</p>
<div class="highlight"><pre><span class="n">article_ct</span> <span class="o">=</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_for_model</span><span class="p">(</span><span class="n">Article</span><span class="p">)</span>
<span class="n">gallery_ct</span> <span class="o">=</span> <span class="n">ContentType</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_for_model</span><span class="p">(</span><span class="n">Gallery</span>
<span class="n">assets</span> <span class="o">=</span> <span class="n">Asset</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">Q</span><span class="p">(</span><span class="n">content_type</span><span class="o">=</span><span class="n">article_type</span><span class="p">,</span> 
                    <span class="n">object_id__in</span><span class="o">=</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">articles</span><span class="p">])</span> <span class="o">|</span>
                <span class="n">Q</span><span class="p">(</span><span class="n">content_type</span><span class="o">=</span><span class="n">gallery_ct</span><span class="p">,</span> <span class="n">object_id__in</span><span class="o">=</span><span class="p">[</span><span class="n">g</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">galleries</span><span class="p">])</span>
             <span class="p">)</span>

    <span class="n">asset_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">asset</span> <span class="ow">in</span> <span class="n">assets</span><span class="p">:</span>
        <span class="n">asset_dict</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">asset</span><span class="o">.</span><span class="n">content_type_id</span><span class="p">,</span> <span class="n">asset</span><span class="o">.</span><span class="n">object_id</span><span class="p">),</span> 
                                         <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">asset</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">article</span> <span class="ow">in</span> <span class="n">articles</span><span class="p">:</span>
        <span class="n">article</span><span class="o">.</span><span class="n">_assets</span> <span class="o">=</span> <span class="n">asset_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">article_ct</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">article</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">gallery</span> <span class="ow">in</span> <span class="n">galleries</span><span class="p">:</span>
        <span class="n">gallery</span><span class="o">.</span><span class="n">_assets</span> <span class="o">=</span> <span class="n">asset_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">_</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">gallery_ct</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">gallery</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="bp">None</span><span class="p">)</span>
</pre></div>


<p>Here we first of all use <code>Q</code> objects to get all the assets of type Article with IDs in the list of articles, plus all those of type Gallery with IDs in the list of galleries. Then we use the fact that each asset knows its own content type ID to create the dictionary keys in the form <code>&lt;content_type_id&gt;_&lt;object_id&gt;</code>. Finally, we loop through the articles and the galleries separately to get the relevant assets for each item.</p>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="http://twitter.com/danielroseman">twitter</a></li>
                            <li><a href="http://github.com/danielroseman">github</a></li>
                            <li><a href="http://stackoverflow.com/users/104349/daniel-roseman">stackoverflow</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>