<!DOCTYPE html>
<html lang="en">
<head>
        <title>Easy create or update</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="../../.././theme/css/main.css" type="text/css" />
        <link href="../../.././feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="rosemanblog ATOM Feed" />
        
        <link href="../../.././feeds/all.xml" type="application/atom+xml" rel="alternate" title="rosemanblog RSS Feed" />
        

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="../../.././css/ie.css"/>
                <script src="../../.././js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="../../.././css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">

        <header id="banner" class="body">
                <h1><a href="../../../.">rosemanblog </a></h1>
                <nav><ul>
                
                
                
                
                
                    <li class="active"><a href="../../.././category/Technical.html">Technical</a></li>
                
                </ul></nav>
        </header><!-- /#banner -->
                
<section id="content" class="body">    
<article>
        <header> <h1 class="entry-title"><a href=""
        rel="bookmark" title="Permalink to Easy create or update">Easy create or update</a></h1> 
<a href="http://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="danielroseman">Tweet</a><script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>
 </header>
        <div class="entry-content">
        <footer class="post-info">
        <abbr class="published" title="2010-03-09T05:38:44">
                Tue 09 March 2010
        </abbr>

        
        <address class="vcard author">
                By <a class="url fn" href="../../.././author/Daniel Roseman.html">Daniel Roseman</a>
        </address>
        
<p>In <a href="../../.././category/Technical.html">Technical</a>. </p>
<p>tags: <a href="../../.././tag/django.html">django</a> <a href="../../.././tag/create_or_update.html">create_or_update</a> <a href="../../.././tag/query-efficiency.html">query-efficiency</a> </p>


</footer><!-- /.post-info -->
        <p>One common database operation that isn't supported out of the box by Django's ORM is <code>create_or_update</code> - in other words, given a set of parameters, either update an existing object or create a new one if there isn't one already.</p>
<p>The naive implementation is to do a <code>get()</code> on the model, catching the <code>DoesNotExist</code> exception if there's no match and instantiating a new object, then updating the attributes and saving. (You wouldn't want to use <code>get_or_create</code> here, as that doesn't allow you to update the instance if it already exists, so you'd have some duplication of code and db queries).</p>
<div class="codehilite"><pre><span class="k">try</span><span class="p">:</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">MyModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field1</span><span class="o">=</span><span class="n">value1</span><span class="p">)</span>
<span class="k">except</span> <span class="n">MyModel</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">MyModel</span><span class="p">()</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">field1</span> <span class="o">=</span> <span class="n">field1</span>
<span class="n">obj</span><span class="o">.</span><span class="n">field2</span> <span class="o">=</span> <span class="n">value2</span>
<span class="n">obj</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>


<p>The only problem with this is that it creates multiple queries: one to get the existing row, and then <em>two</em> to save it - Django checks to see if it should do an insert or an update when you save, which costs another query. Most of the time, this doesn't massively matter: creating and updating is usually done outside of the standard page rendering flow, so it's not a huge problem if it's a tiny bit slower.</p>
<p>But there are times when you do want to optimise this. One, which we recently ran into at work, is when you want to log items to the database in the course of normal page rendering. We do this to let users of our CMS know when they've put items on a page that aren't rendering how they should be, usually because they don't have the right selection of image assets. (There are good operational reasons as to why we can't stop them from entering them in the first place: I won't go into that here.) A further wrinkle for us is that we want to ensure each error only gets one entry in the log table, but should always record the most recent time that particular error scenario was encountered. So, an ideal case for <code>create_or_update</code>, if only it existed.</p>
<p>Of course I can't stand to see unnecessary db queries, so here's an implementation that uses <code>QuerySet.update</code> to do the initial getting and updating if a match exists. The trick is to realise that <code>update</code> returns the number of rows affected by the query - which has been true more or less ever since queryset-refactor landed nearly two years ago, but which was wrongly and explicitly denied in the documentation until recently (and still is denied in the 1.1 docs, even though it's true). We can use this number to tell if a matching row existed - and if it doesn't, we can then simply call <code>create</code> with the same arguments. Simple.</p>
<div class="codehilite"><pre><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;field1&#39;</span><span class="p">:</span> <span class="s">&#39;value1&#39;</span><span class="p">,</span> <span class="s">&#39;field2&#39;</span><span class="p">:</span> <span class="s">&#39;value2&#39;</span><span class="p">}</span>
<span class="n">filter_attrs</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;filter_field&#39;</span><span class="p">:</span> <span class="s">&#39;filtervalue&#39;</span><span class="p">}</span>
<span class="n">rows</span> <span class="o">=</span> <span class="n">MyModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">**</span><span class="n">filter_attrs</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">attrs</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">rows</span><span class="p">:</span>
    <span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">filter_attrs</span><span class="p">)</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">MyModel</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="n">attrs</span><span class="p">)</span>
</pre></div>


<p>The <code>attrs</code> dictionary contains the field names/values to use to update the object, and <code>filter_attrs</code> is the filter names/values to find the object to update. If we're creating a new object, it will of course need to set both the <code>attrs</code> values <em>and</em> the <code>filter_attrs</code>, so we update one dictionary from the other.</p>
<p>Now, note that this will always call a db UPDATE, and if no match exists, it will additionally call an INSERT. Compare this with the original version, which always calls a SELECT, plus another SELECT and an UPDATE if the match exists, but just an INSERT if there's no match. So whether this is more efficient will depend on the use case - if you expect more updates than create, this version should be better (a single UPDATE versus SELECT+UPDATE), but if the reverse is true the original implementation will probably be better.</p>
        </div><!-- /.entry-content -->
        
        <div class="comments">
        <h2>Comments !</h2>
            <div id="disqus_thread"></div>
            <script type="text/javascript">
               var disqus_identifier = "2010/03/09/easy-create-or-update/";
               (function() {
               var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
               dsq.src = 'http://rosemanblog.disqus.com/embed.js';
               (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
              })();
            </script>
        </div>
        

</article>
</section>

        <section id="extras" class="body">
        
        
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="../../.././feeds/all.atom.xml" rel="alternate">atom feed</a></li>
                            
                            <li><a href="../../.././feeds/all.xml" rel="alternate">rss feed</a></li>
                            

                        
                            <li><a href="http://twitter.com/danielroseman">twitter</a></li>
                        
                            <li><a href="http://github.com/danielroseman">github</a></li>
                        
                        </ul>
                </div><!-- /.social -->
        
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://alexis.notmyidea.org/pelican/">pelican</a>, which takes great advantages of <a href="http://python.org">python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->




<script type="text/javascript">
    var disqus_shortname = 'rosemanblog';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

</body>
</html>