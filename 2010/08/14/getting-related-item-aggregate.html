<!DOCTYPE html>
<html lang="en">
<head>
        <title>Getting the related item in an aggregate</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="../../.././theme/css/main.css" type="text/css" />
        <link href="../../.././feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="rosemanblog ATOM Feed" />
        
        <link href="../../.././feeds/all.xml" type="application/atom+xml" rel="alternate" title="rosemanblog RSS Feed" />
        

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="../../.././css/ie.css"/>
                <script src="../../.././js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="../../.././css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">

        <header id="banner" class="body">
                <h1><a href="../../../.">rosemanblog </a></h1>
                <nav><ul>
                
                
                
                
                
                    <li class="active"><a href="../../.././category/Technical.html">Technical</a></li>
                
                </ul></nav>
        </header><!-- /#banner -->
                
<section id="content" class="body">    
<article>
        <header> <h1 class="entry-title"><a href=""
        rel="bookmark" title="Permalink to Getting the related item in an aggregate">Getting the related item in an aggregate</a></h1> 
<a href="http://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="danielroseman">Tweet</a><script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>
 </header>
        <div class="entry-content">
        <footer class="post-info">
        <abbr class="published" title="2010-08-14T16:18:46">
                Sat 14 August 2010
        </abbr>

        
        <address class="vcard author">
                By <a class="url fn" href="../../.././author/Daniel Roseman.html">Daniel Roseman</a>
        </address>
        
<p>In <a href="../../.././category/Technical.html">Technical</a>. </p>
<p>tags: <a href="../../.././tag/django.html">django</a> <a href="../../.././tag/aggregation.html">aggregation</a> <a href="../../.././tag/ORM.html">ORM</a> </p>


</footer><!-- /.post-info -->
        <p>There's a question I see quite a lot at StackOverflow and the Django Users group regarding aggregation in Django. It goes like this: I know how to annotate a max/min value for a related item on each item in a queryset. But how do I get the actual related item itself?</p>
<p>I wish this was easier than it actually is. The problem is that in the underlying SQL, annotating the value is a simple aggregation query on the related item, whereas getting the entire object means moving to a complicated dependent subquery.</p>
<p>To illustrate, take these models:</p>
<div class="codehilite"><pre><span class="k">class</span> <span class="nc">Blog</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Entry</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">blog</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Blog</span><span class="p">)</span>
    <span class="n">added</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>
</pre></div>


<p>Getting the date of the latest Entry for each Blog is simple: </p>
<div class="codehilite"><pre><span class="n">blogs</span> <span class="o">=</span> <span class="n">Blog</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">Max</span><span class="p">(</span><span class="s">&#39;entry__added&#39;</span><span class="p">))</span>
</pre></div>


<p>and the underlying SQL is just as simple:</p>
<div class="codehilite"><pre><span class="k">SELECT</span> <span class="n">blog</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">blog</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="k">MAX</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">added</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">blog_blog</span> <span class="n">blog</span>
<span class="k">JOIN</span> <span class="n">blog_entry</span> <span class="n">entry</span> <span class="k">on</span> <span class="n">entry</span><span class="p">.</span><span class="n">blog_id</span> <span class="o">=</span> <span class="n">blog</span><span class="p">.</span><span class="n">id</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">blog</span><span class="p">.</span><span class="n">id</span>
</pre></div>


<p>But that doesn't work if you want the whole Entry object. You need to do something much more complicated:</p>
<div class="codehilite"><pre><span class="k">SELECT</span> <span class="n">blog</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">blog</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">entry</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">entry</span><span class="p">.</span><span class="n">added</span><span class="p">,</span> <span class="n">entry</span><span class="p">.</span><span class="nb">text</span>
<span class="k">FROM</span> <span class="n">blog_blog</span> <span class="n">blog</span><span class="p">,</span> <span class="n">blog_entry</span> <span class="n">entry</span>
<span class="k">WHERE</span> <span class="n">entry</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="p">(</span>
    <span class="k">SELECT</span> <span class="n">e2</span><span class="p">.</span><span class="n">id</span> <span class="k">FROM</span> <span class="n">blog_entry</span> <span class="n">e2</span>
    <span class="k">WHERE</span> <span class="n">e2</span><span class="p">.</span><span class="n">blog_id</span> <span class="o">=</span> <span class="n">blog</span><span class="p">.</span><span class="n">id</span>
    <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">e2</span><span class="p">.</span><span class="n">added</span> 
    <span class="k">LIMIT</span> <span class="mi">1</span>
<span class="p">);</span>
</pre></div>


<p>and currently there's no support for this in the Django ORM.</p>
<p>Now, you could just pass the above query to the <code>.raw</code> queryset method in Django 1.2: <code>Blog.objects.raw('SELECT...')</code>, and perhaps surprisingly, this will work, in that the extra fields from the Entry model will be appended to each Blog instance. If you needed the actual Entry instance - say if you had some extra methods on the Entry model that you needed to run with each one - you would have to iterate through the queryset and instantiate new Entry objects with the fields from each Blog.</p>
<p>Also note there's another gotcha with raw querysets, which is that they are re-executed every time you slice them or access one of their members - so it's probably best to cast them to a plain list first.</p>
<p>There is another approach which gets you the items related in the normal Django way, so that you can do <code>entry_instance.blog</code>. It does this in two queries, with a bit of Python processing in the meantime. </p>
<div class="codehilite"><pre><span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">Max</span>
<span class="n">blogs</span> <span class="o">=</span> <span class="n">Blog</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">Max</span><span class="p">(</span><span class="s">&#39;entry__added&#39;</span><span class="p">))</span>
<span class="n">values</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([(</span><span class="n">blog</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">blog</span><span class="o">.</span><span class="n">max__entry__added</span><span class="p">)</span> <span class="k">for</span> <span class="n">blog</span> <span class="ow">in</span> <span class="n">blogs</span><span class="p">])</span>

<span class="n">entries</span> <span class="o">=</span> <span class="n">Entry</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">extra</span><span class="p">(</span><span class="n">where</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;(blog_id, added) IN </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">values</span><span class="p">,)])</span>

<span class="n">blog_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">b</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">blogs</span><span class="p">])</span>
<span class="n">entries</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span> 
<span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
    <span class="n">entry</span><span class="o">.</span><span class="n">_blog_cache</span> <span class="o">=</span> <span class="n">blog_dict</span><span class="p">[</span><span class="n">entry</span><span class="o">.</span><span class="n">blog_id</span><span class="p">]</span>
</pre></div>


<p>Here we do a standard annotate query to get the <code>added</code> values for each relevant Entry. Then we can do an <code>extra</code> query to get the actual Entries associated with each <code>(blog_id, max_entry)</code> tuple (note we can't use the <code>params</code> argument for the values list, unfortunately, as it will get double-quoted). Finally, we can re-associate each Entry with its Blog - I've done it that way round to fit in with the standard ForeignKey and its automatic mapping of <code>entry._blog_cache</code> to <code>entry.blog</code>, and since we're only interested in one entry per blog it shouldn't matter whether we have to iterate through blogs or entries.</p>
<p>Again, it's a shame we have to drop to raw SQL for the middle step here. The query depends on matching multiple values for each row, and although it would be possible to do this by iterating through and adding Q objects for each row, it would be an absolutely horrible query. At least we're using <code>extra</code> here, which is arguably better than the <code>raw</code> we used in the first attempt above. </p>
        </div><!-- /.entry-content -->
        
        <div class="comments">
        <h2>Comments !</h2>
            <div id="disqus_thread"></div>
            <script type="text/javascript">
               var disqus_identifier = "2010/08/14/getting-related-item-aggregate/";
               (function() {
               var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
               dsq.src = 'http://rosemanblog.disqus.com/embed.js';
               (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
              })();
            </script>
        </div>
        

</article>
</section>

        <section id="extras" class="body">
        
        
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="../../.././feeds/all.atom.xml" rel="alternate">atom feed</a></li>
                            
                            <li><a href="../../.././feeds/all.xml" rel="alternate">rss feed</a></li>
                            

                        
                            <li><a href="http://twitter.com/danielroseman">twitter</a></li>
                        
                            <li><a href="http://github.com/danielroseman">github</a></li>
                        
                        </ul>
                </div><!-- /.social -->
        
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://alexis.notmyidea.org/pelican/">pelican</a>, which takes great advantages of <a href="http://python.org">python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->




<script type="text/javascript">
    var disqus_shortname = 'rosemanblog';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

</body>
</html>