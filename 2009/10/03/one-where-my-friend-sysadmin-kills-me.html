<!DOCTYPE html>
<html lang="en">
<head>
        <title>The one where my friend the sysadmin kills me</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="../../.././theme/css/main.css" type="text/css" />
        <link href="../../.././feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="rosemanblog ATOM Feed" />
        
        <link href="../../.././feeds/all.xml" type="application/atom+xml" rel="alternate" title="rosemanblog RSS Feed" />
        

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="../../.././css/ie.css"/>
                <script src="../../.././js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="../../.././css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">

        <header id="banner" class="body">
                <h1><a href="../../../.">rosemanblog </a></h1>
                <nav><ul>
                
                
                
                
                
                    <li class="active"><a href="../../.././category/Technical.html">Technical</a></li>
                
                </ul></nav>
        </header><!-- /#banner -->
                
<section id="content" class="body">    
<article>
        <header> <h1 class="entry-title"><a href=""
        rel="bookmark" title="Permalink to The one where my friend the sysadmin kills me">The one where my friend the sysadmin kills me</a></h1> 
<a href="http://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="danielroseman">Tweet</a><script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>
 </header>
        <div class="entry-content">
        <footer class="post-info">
        <abbr class="published" title="2009-10-03T08:14:29">
                Sat 03 October 2009
        </abbr>

        
        <address class="vcard author">
                By <a class="url fn" href="../../.././author/Daniel Roseman.html">Daniel Roseman</a>
        </address>
        
<p>In <a href="../../.././category/Technical.html">Technical</a>. </p>
<p>tags: <a href="../../.././tag/git.html">git</a> </p>


</footer><!-- /.post-info -->
        <p>Warning: this entry is very much a matter of 'This isn't the right way to do it, but it works for me'.</p>
<p>For small projects that are in active development, I frequently have to deploy code changes to the live server. To make this as simple as possible for me, so I can concentrate on the coding, I tend to like running on a live checkout of the code directly from the repo.</p>
<p>I never really got this automated properly with svn, although no doubt it's a simple matter of setting up the right post-commit hooks. However, now I'm working mainly in git, and I thought it would be good if I could push straight from my local repo to the remote one, and automatically see the production code update.</p>
<p>It's fairly easy to set up a remote repository to push to - I followed the instructions <a href="http://toolmantim.com/articles/setting_up_a_new_remote_git_repository">here</a>, which worked a treat. However, this wasn't helping with getting this code to auto-checkout and deploy itself. So I began experimenting, and what I came up with was this.</p>
<p>Firstly, instead of setting up a bare repo as recommended in those instructions, use a standard <code>git init</code> for your remote. If you now try and push to this, git will complain with a long message explaining that "Updating the currently checked out branch may cause confusion". It gives some tips about how to turn off that message, but we can avoid it altogether by using branches.</p>
<p>On the server, simply create and check out a <code>live</code> branch:</p>
<div class="codehilite"><pre>   <span class="n">git</span> <span class="n">branch</span> <span class="n">live</span>
   <span class="n">git</span> <span class="n">checkout</span> <span class="n">live</span>
</pre></div>


<p>Now, we just need a hook that pulls from master to live every time we commit to master. The hook we need is called <code>post-receive</code>, and like all hooks it lives in <code>.git/hooks</code>. Here's mine:</p>
<div class="codehilite"><pre><span class="c">#!/bin/sh</span>
<span class="nb">read </span>params
<span class="nb">cd</span> .. 
<span class="nb">echo</span> <span class="s2">&quot;ASSET_VERSION = &#39;`echo $params|cut -d &quot;</span> <span class="s2">&quot; -f2`&#39;&quot;</span> &gt; local_settings.py
env -i ~/bin/git reset --hard
env -i ~/bin/git pull
<span class="nb">exec</span> ~/webapps/mysite/apache2/bin/restart
</pre></div>


<p>The two git commands simply ensure that the live branch has no local changes, and pulls all changes direct from master - which in turn of course has been updated directly from my development machine.</p>
<p>The rest is me trying to be even cleverer. I wanted an automatic cache-busting mechanism to stop my javascript being cached while in development. So I have a simple <code>local_settings.py</code> file which defines a value which is appended to the querystring of all my asset urls. The hook updates this automatically - it is passed the hash of the current commit, so it reads the parameters (which is far more difficult in bash than it needs to be, by the way), extracts the hash, and writes it to <code>local_settings.py</code>.</p>
<p>The final step is to restart Apache, and we're laughing.</p>
<p>Now, no doubt there are much better ways of doing this. But like I say, it works for me.</p>
        </div><!-- /.entry-content -->
        
        <div class="comments">
        <h2>Comments !</h2>
            <div id="disqus_thread"></div>
            <script type="text/javascript">
               var disqus_identifier = "2009/10/03/one-where-my-friend-sysadmin-kills-me/";
               (function() {
               var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
               dsq.src = 'http://rosemanblog.disqus.com/embed.js';
               (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
              })();
            </script>
        </div>
        

</article>
</section>

        <section id="extras" class="body">
        
        
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="../../.././feeds/all.atom.xml" rel="alternate">atom feed</a></li>
                            
                            <li><a href="../../.././feeds/all.xml" rel="alternate">rss feed</a></li>
                            

                        
                            <li><a href="http://twitter.com/danielroseman">twitter</a></li>
                        
                            <li><a href="http://github.com/danielroseman">github</a></li>
                        
                        </ul>
                </div><!-- /.social -->
        
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://alexis.notmyidea.org/pelican/">pelican</a>, which takes great advantages of <a href="http://python.org">python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->




<script type="text/javascript">
    var disqus_shortname = 'rosemanblog';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

</body>
</html>