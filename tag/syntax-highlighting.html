<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>rosemanblog - syntax highlighting</title>
        <link rel="stylesheet" href="http://blog.roseman.org.uk/theme/css/main.css" />
        <link href="http://blog.roseman.org.uk/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="rosemanblog Atom Feed" />

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="http://blog.roseman.org.uk/">rosemanblog </a></h1>
                <nav><ul>
                    <li><a href="http://blog.roseman.org.uk/category/technical.html">Technical</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="http://blog.roseman.org.uk/2009/12/05/customising-mingus-part-2/">Customising Mingus, part 2</a></h1>
<footer class="post-info">
        <abbr class="published" title="2009-12-05T23:00:04">
                Sat 05 December 2009
        </abbr>

        <address class="vcard author">
                By <a class="url fn" href="http://blog.roseman.org.uk/author/daniel-roseman.html">Daniel Roseman</a>
        </address>
<p>In <a href="http://blog.roseman.org.uk/category/technical.html">Technical</a>. </p>
<p>tags: <a href="http://blog.roseman.org.uk/tag/django.html">django</a><a href="http://blog.roseman.org.uk/tag/mingus.html">mingus</a><a href="http://blog.roseman.org.uk/tag/syntax-highlighting.html">syntax highlighting</a><a href="http://blog.roseman.org.uk/tag/pygments.html">pygments</a></p>
</footer><!-- /.post-info --><p>This is intended to be primarily a technical blog, so I was keen to get the presentation of code snippets correct. I'm a - shall we say - <em>fairly</em> frequent answerer on StackOverflow, and I've got used to their Markdown-enabled edit box. Luckily, the Mingus basic-blog application allows a choice of markup for body text, and even defaults to Markdown. But as always there were quite a few things to improve.</p>
<p>Firstly, I do like StackOverflow's dynamic WYSIWSYG preview of the marked-up copy. Although Markdown syntax is quite simple, it's easy to get it wrong - using a three-space indent  rather than four for code, for example. An instant preview just underneath the text entry field in the admin form is very useful. SO does it using the <code>showdown.js</code> library, which is part of their port of the 'what you see is what you <em>mean</em>' markdown editor, <a href="http://github.com/derobins/wmd">WMD</a>.</p>
<p>It was as easy to integrate the whole of WMD as just the preview, by adding a <code>mingus\admin.py</code> like this:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">forms</span>
<span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="kn">from</span> <span class="nn">django.utils.safestring</span> <span class="kn">import</span> <span class="n">mark_safe</span>
<span class="kn">from</span> <span class="nn">basic.blog.models</span> <span class="kn">import</span> <span class="n">Post</span>
<span class="kn">from</span> <span class="nn">basic.blog.admin</span> <span class="kn">import</span> <span class="n">PostAdmin</span>

<span class="k">class</span> <span class="nc">WMDEditor</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">Textarea</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">&#39;attrs&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;class&#39;</span><span class="p">:</span><span class="s">&#39;vLargeTextField&#39;</span><span class="p">})</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">WMDEditor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">attrs</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">rendered</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">WMDEditor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rendered</span> <span class="o">+</span> <span class="n">mark_safe</span><span class="p">(</span><span class="s">u&#39;&#39;&#39;</span>
<span class="s">            &lt;div id=&#39;wmd-container&#39;&gt;</span>
<span class="s">            &lt;div id=&#39;wmd-button-bar&#39;&gt;&lt;/div&gt;</span>
<span class="s">            &lt;div id=&#39;wmd-preview&#39;&gt;&lt;/div&gt;</span>
<span class="s">            &lt;script type=&quot;text/javascript&quot;&gt;</span>
<span class="s">            wmd_options = {</span>
<span class="s">                output: &quot;Markdown&quot;,</span>
<span class="s">                buttons: &quot;bold italic | link blockquote code image | ol ul&quot;</span>
<span class="s">            };</span>
<span class="s">            &lt;/script&gt;</span>
<span class="s">            &lt;script type=&quot;text/javascript&quot; src=&quot;</span><span class="si">%s</span><span class="s">static/js/wmd.js&quot;&gt;&lt;/script&gt;</span>
<span class="s">            &lt;/div&gt;&#39;&#39;&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">MEDIA_URL</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">PostForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">ModelForm</span><span class="p">):</span>
    <span class="n">body</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">widget</span><span class="o">=</span><span class="n">WMDEditor</span><span class="p">)</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Post</span>

<span class="k">class</span> <span class="nc">WMDPostAdmin</span><span class="p">(</span><span class="n">PostAdmin</span><span class="p">):</span>
    <span class="n">form</span> <span class="o">=</span> <span class="n">PostForm</span>

    <span class="k">class</span> <span class="nc">Media</span><span class="p">:</span>
        <span class="n">css</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&quot;all&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s">&quot;static/css/wmd.css&quot;</span><span class="p">,)</span>
        <span class="p">}</span>
        <span class="n">js</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;static/js/showdown.js&quot;</span><span class="p">,)</span>

<span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="n">Post</span><span class="p">)</span>
<span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Post</span><span class="p">,</span> <span class="n">WMDPostAdmin</span><span class="p">)</span>
</pre></div>


<p>Because Mingus already does some Javascript on the Post admin to add the 'body inlines' section under the main textbox, I've made the WMD button bar appear underneath that, on top of the preview, instead of on top of the actual textarea. A bit weird, but it does work - it's not as if I use it all the time, anyway. This no doubt breaks if you use another markup language, but I always use Markdown, so no problem there.</p>
<p>So, from markup to syntax highlighting. Mingus is, unfortunately, a bit confusing here. Partly this is a result of Kevin's desire to integrate as many standalone applications as possible, and only write the minimum of glue code. However, this means that there are several applications that potentially supply markup functionality, and it confused me for quite a while. These include the django-extensions app, which includes the <code>syntax_color</code> templatetag; and django-sugar, which includes the <code>pygment_tags</code> library.</p>
<p>However, the basic django-blog app actually deals with markup and highlighting itself already. On saving a post, the markup is translated into HTML and saved in a <code>body_markup</code> field, thanks to the django-markup app. What I didn't realise is that django-markup already runs the formatted text through <code>pygments</code> to add the highlighting. The reason I didn't realise this is that pygments turns out not to be very clever in guessing the code language. If you don't tell it explicitly, it doesn't do anything. In the absence of a hard-coded hint, its attempt to guess the language is limited to looking at the first line of the code, where it hopes to see a pseudo-shebang line: </p>
<div class="highlight"><pre><span class="p">...</span>
<span class="cp">#! python</span>
</pre></div>


<p>Once I started doing that, highlighting worked as expected (although there were some minor CSS issues - on some browsers the font used for <code>pre</code> was far too big). This also meant I could remove the call to the django-sugar <code>pygmentize</code> filter that mingus has for some reason added to all the blog templates.  </p>
<p>I can't help feeling the proliferation of markup/highlighting code within mingus is a bit silly. I only realised in writing this that there is actually yet another place where highlighting could take place, as the Markdown library itself has an extension to call pygments (although presumably django-markup prefers to do this explicitly because other markup libraries don't have this extension).</p>
<p>There's one issue that remains unresolved. As well as the now-removed pygmentize filter, mingus also runs blog content through <code>render_inlines</code>, which allows insertion of arbitrary Django model content within a blog post. However, for some reason this removes all the indentation from code blocks - obviously not very useful when posting Python. I'm not using the inlines at the moment anyway, so I've removed them from the template until I can work out what's going on.</p>
<p>Other than that, everything works and the blog is now ready to use.</p><p>There are <a href="http://blog.roseman.org.uk/2009/12/05/customising-mingus-part-2/#disqus_thread">comments</a>.</p>                </article>
<p class="paginator">
    Page 1 / 1
</p>
            </aside><!-- /#featured -->
            </ol><!-- /#posts-list -->
            </section><!-- /#content -->
        <section id="extras" class="body">
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="http://blog.roseman.org.uk/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="http://twitter.com/danielroseman">twitter</a></li>
                            <li><a href="http://github.com/danielroseman">github</a></li>
                            <li><a href="http://stackoverflow.com/users/104349/daniel-roseman">stackoverflow</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

<script type="text/javascript">
    var disqus_shortname = 'rosemanblog';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>