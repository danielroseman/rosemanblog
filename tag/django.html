<!DOCTYPE html>
<html lang="en">
<head>
        <title>rosemanblog - django</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href=".././theme/css/main.css" type="text/css" />
        <link href=".././feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="rosemanblog ATOM Feed" />
        
        <link href=".././feeds/all.xml" type="application/atom+xml" rel="alternate" title="rosemanblog RSS Feed" />
        

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href=".././css/ie.css"/>
                <script src=".././js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href=".././css/ie6.css"/><![endif]-->

</head>

<body id="index" class="home">

        <header id="banner" class="body">
                <h1><a href="../.">rosemanblog </a></h1>
                <nav><ul>
                
                
                
                
                
                    <li ><a href=".././category/Technical.html">Technical</a></li>
                
                </ul></nav>
        </header><!-- /#banner -->
                

            

        
        
            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href=".././2012/05/30/querysets-arent-as-lazy-as-you-think/">Querysets aren't as lazy as you think</a></h1> 
                    <footer class="post-info">
        <abbr class="published" title="2012-05-30T20:30:00">
                Wed 30 May 2012
        </abbr>

        
        <address class="vcard author">
                By <a class="url fn" href=".././author/Daniel Roseman.html">Daniel Roseman</a>
        </address>
        
<p>In <a href=".././category/Technical.html">Technical</a>. </p>
<p>tags: <a href=".././tag/django.html">django</a> <a href=".././tag/queryset.html">queryset</a> </p>


</footer><!-- /.post-info --><p>It should be reasonably well-known by now that querysets are lazy. That is, simply instantiating a queryset via a manager doesn't actually hit the database: that doesn't happen until the queryset is sliced or iterated. That's why the first field definition in the form below is safe, but not the second:</p>
<div class="codehilite"><pre><span class="n">class</span> <span class="n">MyForm</span><span class="p">(</span><span class="n">forms</span><span class="p">.</span><span class="n">Form</span><span class="p">)</span><span class="o">:</span>
    <span class="n">my_field</span> <span class="o">=</span> <span class="n">forms</span><span class="p">.</span><span class="n">ModelChoiceField</span><span class="p">(</span><span class="n">queryset</span><span class="o">=</span><span class="n">MyModel</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">all</span><span class="p">())</span>
    <span class="n">my_datefield</span> <span class="o">=</span> <span class="n">forms</span><span class="p">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">initial</span><span class="o">=</span><span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">())</span>
</pre></div>


<p>Even though both elements are calling methods on definition, the first is safe because the queryset is not evaluated at that time, whereas the second is not safe because it <em>is</em> evaluated at that time, and therefore remains the same for the duration of the current process (which can be many days). For the record, you should always pass the <em>callable</em>: <code>initial=datetime.datetime.now</code>, without the calling brackets.</p>
<p>Now, there are a couple of gotchas here. It is perfectly possible to define manager methods that are not safe to use in places like the <code>queryset</code> argument to the first field above. Here's an example:</p>
<div class="codehilite"><pre><span class="n">class</span> <span class="n">PublishedManager</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">Manager</span><span class="p">)</span><span class="o">:</span>
    <span class="n">def</span> <span class="n">get_query_set</span><span class="p">(</span><span class="n">self</span><span class="p">)</span><span class="o">:</span>
        <span class="k">return</span> <span class="n">super</span><span class="p">(</span><span class="n">PublishedManager</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="n">get_query_set</span><span class="p">().</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">published_date__lte</span><span class="o">=</span><span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">())</span>
</pre></div>


<p>Clearly, this is an attempt to create a manager that automatically filters items which have been published. In the normal course of calling this in a view, it will work exactly as expected. But if you passed it into the <code>queryset</code> parameter of the form field, the same thing will happen as with the date field: the cut-off point will always be set when the form is first imported, and will persist for the life of the process.</p>
<p>This is because there's nothing magical about manager methods that makes them lazy. The laziness comes further down, inside the QuerySet class itself. This method, which is called automatically by the <code>all()</code> method, will be evaluated when it is called - ie when the form is first defined. At that point, the right-hand-side of the query expression will also be evaluated, and passed into the main Manager <code>get_query_set</code> method. So no matter when you instantiate your form after this, during the lifetime of the process you will never see any objects whose <code>published_date</code> is greater than the first time.</p>
<p>But note that if you change the <code>published_date</code> of an existing object to before that time - or even create a new object with that date - you <em>will</em> see it. The queryset is still lazy, and the database will be queried each time the form is instantiated: but that <code>published_date</code> parameter is fixed.</p><p>There are <a href=".././2012/05/30/querysets-arent-as-lazy-as-you-think/#disqus_thread">comments</a>.</p>
                </article>
                
            </aside><!-- /#featured -->
            
                <section id="content" class="body">
                    <h1>Other articles</h1>
                    <hr />
                        <ol id="posts-list" class="hfeed">
            
        
        
        
        

        
         
            
            <li><article class="hentry">    
                <header>
                        <h1><a href=".././2010/08/14/getting-related-item-aggregate/" rel="bookmark" title="Permalink to Getting the related item in an aggregate">Getting the related item in an aggregate</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2010-08-14T16:18:46">
                Sat 14 August 2010
        </abbr>

        
        <address class="vcard author">
                By <a class="url fn" href=".././author/Daniel Roseman.html">Daniel Roseman</a>
        </address>
        
<p>In <a href=".././category/Technical.html">Technical</a>. </p>
<p>tags: <a href=".././tag/django.html">django</a> <a href=".././tag/aggregation.html">aggregation</a> <a href=".././tag/ORM.html">ORM</a> </p>


</footer><!-- /.post-info -->
                <p>There's a question I see quite a lot at StackOverflow and the Django Users group regarding aggregation in Django. It goes like this: I know how to annotate a max/min value for a related item on each item in a queryset. But how do I get the actual ...</p>
                <a class="readmore" href=".././2010/08/14/getting-related-item-aggregate/">read more</a>
                <p>There are <a href=".././2010/08/14/getting-related-item-aggregate/#disqus_thread">comments</a>.</p>
                </div><!-- /.entry-content -->
            </article></li>
        
        
        

        
         
            
            <li><article class="hentry">    
                <header>
                        <h1><a href=".././2010/07/25/europython-2010-talk-advanced-django-orm-technique/" rel="bookmark" title="Permalink to Europython 2010 talk: Advanced Django ORM Techniques">Europython 2010 talk: Advanced Django ORM Techniques</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2010-07-25T16:15:53">
                Sun 25 July 2010
        </abbr>

        
        <address class="vcard author">
                By <a class="url fn" href=".././author/Daniel Roseman.html">Daniel Roseman</a>
        </address>
        
<p>In <a href=".././category/Technical.html">Technical</a>. </p>
<p>tags: <a href=".././tag/django.html">django</a> <a href=".././tag/python.html">python</a> <a href=".././tag/europython.html">europython</a> <a href=".././tag/conference.html">conference</a> </p>


</footer><!-- /.post-info -->
                <p>Here are the slides from my talk at Europython 2010, Advanced Django ORM Techniques.</p>
<div style="width:425px" id="__ss_4817160"><strong style="display:block;margin:12px 0 4px"><a href="http://www.slideshare.net/danielroseman/advanced-django-orm-techniques" title="Advanced Django ORM techniques">Advanced Django ORM techniques</a></strong><object id="__sse4817160" width="425" height="355"><param name="movie" value="http://static.slidesharecdn.com/swf/ssplayer2.swf?doc=europython-100722111505-phpapp01&stripped_title=advanced-django-orm-techniques" /><param name="allowFullScreen" value="true"/><param name="allowScriptAccess" value="always"/><embed name="__sse4817160" src="http://static.slidesharecdn.com/swf/ssplayer2.swf?doc=europython-100722111505-phpapp01&stripped_title=advanced-django-orm-techniques" type="application/x-shockwave-flash" allowscriptaccess="always" allowfullscreen="true" width="425" height="355"></embed></object><div style="padding:5px 0 12px"></div></div>

<p>The talk is mainly a summary of the query optimisation tricks I've previously talked about on this blog, although I did begin by explaining briefly how models, fields and relationships work ...</p>
                <a class="readmore" href=".././2010/07/25/europython-2010-talk-advanced-django-orm-technique/">read more</a>
                <p>There are <a href=".././2010/07/25/europython-2010-talk-advanced-django-orm-technique/#disqus_thread">comments</a>.</p>
                </div><!-- /.entry-content -->
            </article></li>
        
        
        

        
         
            
            <li><article class="hentry">    
                <header>
                        <h1><a href=".././2010/06/02/class-based-views-and-thread-safety/" rel="bookmark" title="Permalink to Class-based views and thread safety">Class-based views and thread safety</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2010-06-02T06:20:16">
                Wed 02 June 2010
        </abbr>

        
        <address class="vcard author">
                By <a class="url fn" href=".././author/Daniel Roseman.html">Daniel Roseman</a>
        </address>
        
<p>In <a href=".././category/Technical.html">Technical</a>. </p>
<p>tags: <a href=".././tag/django.html">django</a> <a href=".././tag/thread_safety.html">thread_safety</a> <a href=".././tag/class_based_view.html">class_based_view</a> </p>


</footer><!-- /.post-info -->
                <p>I <a href="../static/2010/02/1/middleware-post-processing-django-gotcha">previously wrote about</a> a thread-safety bug I encountered in writing a middleware object. I recently found a very similar situation in a class-based view I was modifying, and thought it was worth writing up what the problem was and how I solved it. Interestingly, there's <a href="http://groups.google.com/group/django-developers/browse_thread/thread/e23d9a5a58fe5891">a discussion going ...</a></p>
                <a class="readmore" href=".././2010/06/02/class-based-views-and-thread-safety/">read more</a>
                <p>There are <a href=".././2010/06/02/class-based-views-and-thread-safety/#disqus_thread">comments</a>.</p>
                </div><!-- /.entry-content -->
            </article></li>
        
        
        

        
         
            
            <li><article class="hentry">    
                <header>
                        <h1><a href=".././2010/05/10/django-aggregation-and-simple-group/" rel="bookmark" title="Permalink to Django aggregation and a simple GROUP BY">Django aggregation and a simple GROUP BY</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2010-05-10T11:50:44">
                Mon 10 May 2010
        </abbr>

        
        <address class="vcard author">
                By <a class="url fn" href=".././author/Daniel Roseman.html">Daniel Roseman</a>
        </address>
        
<p>In <a href=".././category/Technical.html">Technical</a>. </p>
<p>tags: <a href=".././tag/django.html">django</a> <a href=".././tag/aggregation.html">aggregation</a> <a href=".././tag/ORM.html">ORM</a> <a href=".././tag/group-by.html">group-by</a> </p>


</footer><!-- /.post-info -->
                <p>I love Django's aggregation framework. It very successfully abstracts the common aggregration tasks into a Pythonic syntax that sits extremely well with the rest of the ORM, and the documentation explains it all without a single reference to SQL.</p>
<p>But sometimes that very abstraction gets in the way of ...</p>
                <a class="readmore" href=".././2010/05/10/django-aggregation-and-simple-group/">read more</a>
                <p>There are <a href=".././2010/05/10/django-aggregation-and-simple-group/#disqus_thread">comments</a>.</p>
                </div><!-- /.entry-content -->
            </article></li>
        
        
        

        
         
            
            <li><article class="hentry">    
                <header>
                        <h1><a href=".././2010/04/21/vim-autocomplete-django-and-virtualenv/" rel="bookmark" title="Permalink to Vim autocomplete, Django and virtualenv">Vim autocomplete, Django and virtualenv</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2010-04-21T17:41:49">
                Wed 21 April 2010
        </abbr>

        
        <address class="vcard author">
                By <a class="url fn" href=".././author/Daniel Roseman.html">Daniel Roseman</a>
        </address>
        
<p>In <a href=".././category/Technical.html">Technical</a>. </p>
<p>tags: <a href=".././tag/django.html">django</a> <a href=".././tag/vim.html">vim</a> <a href=".././tag/virtualenv.html">virtualenv</a> <a href=".././tag/autocomplete.html">autocomplete</a> </p>


</footer><!-- /.post-info -->
                <p>One of the features I quite missed when I first moved from Komodo to Textmate as my main editor was autocompletion. Although I didn't use it very much, it was occasionally useful to be reminded of the methods available on a class, without having to look up the documentation ...</p>
                <a class="readmore" href=".././2010/04/21/vim-autocomplete-django-and-virtualenv/">read more</a>
                <p>There are <a href=".././2010/04/21/vim-autocomplete-django-and-virtualenv/#disqus_thread">comments</a>.</p>
                </div><!-- /.entry-content -->
            </article></li>
        
        
        

        
         
            
            <li><article class="hentry">    
                <header>
                        <h1><a href=".././2010/04/21/bye-bye-djangocomments-hello-disqus/" rel="bookmark" title="Permalink to Bye-bye django.comments, hello Disqus">Bye-bye django.comments, hello Disqus</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2010-04-21T04:29:31">
                Wed 21 April 2010
        </abbr>

        
        <address class="vcard author">
                By <a class="url fn" href=".././author/Daniel Roseman.html">Daniel Roseman</a>
        </address>
        
<p>In <a href=".././category/Technical.html">Technical</a>. </p>
<p>tags: <a href=".././tag/django.html">django</a> <a href=".././tag/mingus.html">mingus</a> <a href=".././tag/disqus.html">disqus</a> </p>


</footer><!-- /.post-info -->
                <p>So, I've learned my lesson. When I first set up this blog I said <a href="../static/2009/10/4/customising-django-mingus">at great length</a> that I'd prefer using Django's built-in commenting system than the third-party Disqus service that Mingus uses by default.</p>
<p>Well, after a week of trying to stop a flood of spam ...</p>
                <a class="readmore" href=".././2010/04/21/bye-bye-djangocomments-hello-disqus/">read more</a>
                <p>There are <a href=".././2010/04/21/bye-bye-djangocomments-hello-disqus/#disqus_thread">comments</a>.</p>
                </div><!-- /.entry-content -->
            </article></li>
        
        
        

        
         
            
            <li><article class="hentry">    
                <header>
                        <h1><a href=".././2010/04/13/temporary-models-django/" rel="bookmark" title="Permalink to Temporary models in Django">Temporary models in Django</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2010-04-13T11:40:05">
                Tue 13 April 2010
        </abbr>

        
        <address class="vcard author">
                By <a class="url fn" href=".././author/Daniel Roseman.html">Daniel Roseman</a>
        </address>
        
<p>In <a href=".././category/Technical.html">Technical</a>. </p>
<p>tags: <a href=".././tag/django.html">django</a> <a href=".././tag/models.html">models</a> </p>


</footer><!-- /.post-info -->
                <p>Occasionally I need to create a temporary model within a Django application.</p>
<p>The most recent occasion for this was a one-off management command I was writing to import some data from a legacy system. The old database, for some reason, eschewed foreign keys in favour of char fields in a ...</p>
                <a class="readmore" href=".././2010/04/13/temporary-models-django/">read more</a>
                <p>There are <a href=".././2010/04/13/temporary-models-django/#disqus_thread">comments</a>.</p>
                </div><!-- /.entry-content -->
            </article></li>
        
        
        

        
         
            
            <li><article class="hentry">    
                <header>
                        <h1><a href=".././2010/03/09/easy-create-or-update/" rel="bookmark" title="Permalink to Easy create or update">Easy create or update</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2010-03-09T05:38:44">
                Tue 09 March 2010
        </abbr>

        
        <address class="vcard author">
                By <a class="url fn" href=".././author/Daniel Roseman.html">Daniel Roseman</a>
        </address>
        
<p>In <a href=".././category/Technical.html">Technical</a>. </p>
<p>tags: <a href=".././tag/django.html">django</a> <a href=".././tag/create_or_update.html">create_or_update</a> <a href=".././tag/query-efficiency.html">query-efficiency</a> </p>


</footer><!-- /.post-info -->
                <p>One common database operation that isn't supported out of the box by Django's ORM is <code>create_or_update</code> - in other words, given a set of parameters, either update an existing object or create a new one if there isn't one already.</p>
<p>The naive implementation is to do a <code>get ...</code></p>
                <a class="readmore" href=".././2010/03/09/easy-create-or-update/">read more</a>
                <p>There are <a href=".././2010/03/09/easy-create-or-update/#disqus_thread">comments</a>.</p>
                </div><!-- /.entry-content -->
            </article></li>
        
        
        

        
         
            
            <li><article class="hentry">    
                <header>
                        <h1><a href=".././2010/02/22/django-patterns-part-4-forwards-generic-relations/" rel="bookmark" title="Permalink to Django patterns, part 4: forwards generic relations">Django patterns, part 4: forwards generic relations</a></h1>
                </header>
                
                <div class="entry-content">
                <footer class="post-info">
        <abbr class="published" title="2010-02-22T06:50:55">
                Mon 22 February 2010
        </abbr>

        
        <address class="vcard author">
                By <a class="url fn" href=".././author/Daniel Roseman.html">Daniel Roseman</a>
        </address>
        
<p>In <a href=".././category/Technical.html">Technical</a>. </p>
<p>tags: <a href=".././tag/django.html">django</a> <a href=".././tag/patterns.html">patterns</a> <a href=".././tag/generic-relation.html">generic-relation</a> <a href=".././tag/select_related.html">select_related</a> <a href=".././tag/query-efficiency.html">query-efficiency</a> </p>


</footer><!-- /.post-info -->
                <p>My <a href="../static/2010/02/15/django-patterns-part-3-efficient-generic-relations">last post</a> talked about how to follow reverse generic relations efficiently. However, there's a further potential inefficiency in using generic relations, and that's the forward relationship.</p>
<p>If once again we take the example of an Asset model with a GenericForeignKey used to point at Articles and Galleries ...</p>
                <a class="readmore" href=".././2010/02/22/django-patterns-part-4-forwards-generic-relations/">read more</a>
                <p>There are <a href=".././2010/02/22/django-patterns-part-4-forwards-generic-relations/#disqus_thread">comments</a>.</p>
                </div><!-- /.entry-content -->
            </article></li>
        
        
            
<p class="paginator">
    
    Page 1 / 2
    
        <a href=".././tag/django2.html">&raquo;</a>
    
</p>

        

    
    </ol><!-- /#posts-list -->
    </section><!-- /#content -->



        <section id="extras" class="body">
        
        
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href=".././feeds/all.atom.xml" rel="alternate">atom feed</a></li>
                            
                            <li><a href=".././feeds/all.xml" rel="alternate">rss feed</a></li>
                            

                        
                            <li><a href="http://twitter.com/danielroseman">twitter</a></li>
                        
                            <li><a href="http://github.com/danielroseman">github</a></li>
                        
                        </ul>
                </div><!-- /.social -->
        
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://alexis.notmyidea.org/pelican/">pelican</a>, which takes great advantages of <a href="http://python.org">python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->




<script type="text/javascript">
    var disqus_shortname = 'rosemanblog';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

</body>
</html>