<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>rosemanblog - middleware</title>
        <link rel="stylesheet" href="../theme/css/main.css" />

        <!--[if IE]>
            <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="../">rosemanblog </a></h1>
                <nav><ul>
                    <li><a href="../category/technical.html">Technical</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="../2010/02/01/middleware-post-processing-django-gotcha/">Middleware post-processing in Django: a gotcha</a></h1>
<footer class="post-info">
        <abbr class="published" title="2010-02-01T17:17:31">
                Mon 01 February 2010
        </abbr>

        <address class="vcard author">
                By <a class="url fn" href="../author/daniel-roseman.html">Daniel Roseman</a>
        </address>
<p>In <a href="../category/technical.html">Technical</a>. </p>
<p>tags: <a href="../tag/django.html">django</a><a href="../tag/middleware.html">middleware</a></p>
</footer><!-- /.post-info --><p>One of the requirements for the new <a href="http://www.heart.co.uk/">Heart website</a> we've just launched was to allow users to personalise their location to one of 33 radio stations across the country. For various reasons, this meant rewriting all the links on the page, dynamically, depending on the user's location setting.</p>
<p>The easiest place to do this sort of post-processing in Django is in response middleware. So I wrote a quick class that used regexes to grab all the <code>href</code> and <code>action</code> attributes (for <code>a</code> and <code>form</code> elements respectively - images didn't need localising) and add the relevant locations. Because it was dynamic, I used the ability of <code>re.sub</code> to call a function to determine the replacement value; and to save on multiple database queries, I saved various things in the instance. So it looked a bit like this:</p>
<div class="highlight"><pre><span class="n">href</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;(href|action)=[&quot;</span><span class="se">\&#39;</span><span class="s">](.+?)[&quot;</span><span class="se">\&#39;</span><span class="s">]&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">LocalisationMiddleware</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">process_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_station</span> <span class="o">=</span> <span class="n">get_station</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stations</span> <span class="o">=</span> <span class="n">Station</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;slug&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="n">content</span> <span class="o">=</span> <span class="n">href</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">re_replace</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf8&#39;</span><span class="p">))</span>
        <span class="n">response</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>

    <span class="k">def</span> <span class="nf">re_replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matchobj</span><span class="p">):</span>
        <span class="n">current_station</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_station</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s">&quot;/</span><span class="si">%s%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">current_station</span><span class="o">.</span><span class="n">slug</span><span class="p">,</span> <span class="n">matchobj</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">return</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">=</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">matchobj</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">url</span><span class="p">)</span>
</pre></div>


<p>But then, during testing, we started getting some rather odd bug reports. Someone would be happily browsing the London pages, and would suddenly get a link pointing at Essex - which is supposed to be impossible.</p>
<p>We eventually realised what the problem was. Django middleware is instantiated once per process: so several requests were being serviced by the same instance, and the values of the local instance attributes - in particular <code>self.current_station</code> - were being leaked across requests.</p>
<p>The solution is to use a separate object to contain the current station and the <code>re_replace</code> method, and instantiate it explicitly in <code>process_response</code>:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">LocalisationMiddleware</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">process_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
         <span class="n">url_replacement</span> <span class="o">=</span> <span class="n">UrlReplacement</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
         <span class="n">content</span> <span class="o">=</span> <span class="n">href</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">url_replacement</span><span class="p">,</span>
                           <span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf8&#39;</span><span class="p">))</span>
        <span class="c"># etc</span>

<span class="k">class</span> <span class="nc">UrlReplacement</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">current_station</span> <span class="o">=</span> <span class="n">get_station</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">stations</span> <span class="o">=</span> <span class="n">Station</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s">&#39;slug&#39;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">matchobj</span><span class="p">):</span>
        <span class="c"># do replacements</span>
</pre></div>                </article>
<p class="paginator">
    Page 1 / 1
</p>
            </aside><!-- /#featured -->
            </ol><!-- /#posts-list -->
            </section><!-- /#content -->
        <section id="extras" class="body">
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="http://twitter.com/danielroseman">twitter</a></li>
                            <li><a href="http://github.com/danielroseman">github</a></li>
                            <li><a href="http://stackoverflow.com/users/104349/daniel-roseman">stackoverflow</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>